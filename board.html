<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Detective Board Pro</title>

<style>
*{margin:0;padding:0;box-sizing:border-box;}
html,body{
    width:100%;
    height:100%;
    overflow:hidden;
    background:#111;
    font-family:Arial;
}

/* Toolbar */
#toolbar{
    position:fixed;
    top:10px;
    left:50%;
    transform:translateX(-50%);
    background:#222;
    padding:10px 15px;
    border-radius:8px;
    display:flex;
    gap:10px;
    z-index:1000;
}
.tool-btn{
    padding:6px 12px;
    background:#333;
    color:#fff;
    border:none;
    border-radius:5px;
    cursor:pointer;
}
.tool-btn.active{
    background:#ff9800;
}

/* Grid */
#grid{
    position:fixed;
    top:0;
    left:0;
    z-index:0;
}

/* Connection canvas */
#connections{
    position:absolute;
    top:0;
    left:0;
    z-index:1;
    pointer-events:none;
}

/* Board */
#board{
    position:absolute;
    top:0;
    left:0;
    transform-origin:0 0;
    z-index:2;
}

/* Note */
.note{
    position:absolute;
    width:200px;
    min-height:120px;
    background:#fff7a8;
    padding:10px;
    border-radius:6px;
    box-shadow:0 6px 15px rgba(0,0,0,0.4);
}
.note textarea{
    width:100%;
    height:100%;
    border:none;
    resize:none;
    background:transparent;
    outline:none;
}

/* Image */
.board-image{
    position:absolute;
    max-width:200px;
    cursor:move;
}
</style>
</head>
<body>

<div id="toolbar">
    <button class="tool-btn active" data-tool="select">Select</button>
    <button class="tool-btn" data-tool="note">Note</button>
    <button class="tool-btn" data-tool="image">Image</button>
    <button class="tool-btn" data-tool="connect">Connect</button>
</div>

<canvas id="grid"></canvas>
<canvas id="connections"></canvas>
<div id="board"></div>

<script>
const board = document.getElementById("board");
const gridCanvas = document.getElementById("grid");
const gridCtx = gridCanvas.getContext("2d");
const connCanvas = document.getElementById("connections");
const connCtx = connCanvas.getContext("2d");

let zoom = 1;
let panX = window.innerWidth/2;
let panY = window.innerHeight/2;

let currentTool = "select";
let elements = [];
let connections = [];
let connectStart = null;
let idCounter = 0;

/* ---------- Resize ---------- */

function resize(){
    gridCanvas.width = window.innerWidth;
    gridCanvas.height = window.innerHeight;
    connCanvas.width = window.innerWidth;
    connCanvas.height = window.innerHeight;
    drawGrid();
    drawConnections();
}
window.addEventListener("resize", resize);
resize();

/* ---------- Grid ---------- */

function drawGrid(){
    gridCtx.clearRect(0,0,gridCanvas.width,gridCanvas.height);

    const size = 50 * zoom;
    const offsetX = panX % size;
    const offsetY = panY % size;

    gridCtx.strokeStyle = "#222";

    for(let x=offsetX;x<gridCanvas.width;x+=size){
        gridCtx.beginPath();
        gridCtx.moveTo(x,0);
        gridCtx.lineTo(x,gridCanvas.height);
        gridCtx.stroke();
    }

    for(let y=offsetY;y<gridCanvas.height;y+=size){
        gridCtx.beginPath();
        gridCtx.moveTo(0,y);
        gridCtx.lineTo(gridCanvas.width,y);
        gridCtx.stroke();
    }
}

/* ---------- Transform ---------- */

function updateTransform(){
    board.style.transform =
        `translate3d(${panX}px,${panY}px,0) scale(${zoom})`;
    drawGrid();
    drawConnections();
}

/* ---------- Zoom ---------- */

window.addEventListener("wheel",(e)=>{
    e.preventDefault();

    const speed = 0.0015;
    const delta = -e.deltaY * speed;
    const newZoom = zoom * Math.exp(delta);
    if(newZoom < 0.1 || newZoom > 3) return;

    const worldX = (e.clientX - panX)/zoom;
    const worldY = (e.clientY - panY)/zoom;

    zoom = newZoom;
    panX = e.clientX - worldX*zoom;
    panY = e.clientY - worldY*zoom;

    updateTransform();
},{passive:false});

/* ---------- Pan ---------- */

let isPanning=false,startX,startY;

window.addEventListener("mousedown",(e)=>{
    if(e.ctrlKey){
        isPanning=true;
        startX=e.clientX-panX;
        startY=e.clientY-panY;
    }
});
window.addEventListener("mousemove",(e)=>{
    if(!isPanning) return;
    panX=e.clientX-startX;
    panY=e.clientY-startY;
    updateTransform();
});
window.addEventListener("mouseup",()=>isPanning=false);

/* ---------- Toolbar ---------- */

document.querySelectorAll(".tool-btn").forEach(btn=>{
    btn.onclick=()=>{
        document.querySelectorAll(".tool-btn")
        .forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        currentTool=btn.dataset.tool;
        connectStart=null;
    };
});
/* ---------- Shift = Temporary Connect Mode ---------- */

let previousTool = "select";

window.addEventListener("keydown", (e) => {
    if (e.key === "Shift" && currentTool !== "connect") {
        previousTool = currentTool;
        currentTool = "connect";

        document.querySelectorAll(".tool-btn")
            .forEach(b => b.classList.remove("active"));
        document.querySelector("[data-tool='connect']")
            .classList.add("active");
    }
});

window.addEventListener("keyup", (e) => {
    if (e.key === "Shift") {
        currentTool = previousTool;

        document.querySelectorAll(".tool-btn")
            .forEach(b => b.classList.remove("active"));
        document.querySelector(`[data-tool='${previousTool}']`)
            .classList.add("active");

        connectStart = null;
    }
});


/* ---------- Create Note ---------- */

function createNote(x,y){
    const id=idCounter++;
    const note=document.createElement("div");
    note.className="note";
    note.dataset.id=id;
    note.style.left=x+"px";
    note.style.top=y+"px";

    const textarea = document.createElement("textarea");
    note.appendChild(textarea);

    board.appendChild(note);
    elements.push({id,type:"note",el:note});
    makeDraggable(note);

    // ðŸ”¥ AUTO EDIT MODE
    setTimeout(()=>{
        textarea.focus();
        textarea.selectionStart = textarea.selectionEnd = textarea.value.length;
    },0);
}


/* ---------- Create Image ---------- */

function createImage(x,y){
    const input=document.createElement("input");
    input.type="file";
    input.accept="image/*";
    input.onchange=e=>{
        const file=e.target.files[0];
        const reader=new FileReader();
        reader.onload=ev=>{
            const img=document.createElement("img");
            img.src=ev.target.result;
            img.className="board-image";
            img.style.left=x+"px";
            img.style.top=y+"px";
            board.appendChild(img);
            const id=idCounter++;
            img.dataset.id=id;
            elements.push({id,type:"image",el:img});
            makeDraggable(img);
        };
        reader.readAsDataURL(file);
    };
    input.click();
}

/* ---------- Connect Tool ---------- */

window.addEventListener("click",(e)=>{
    if(currentTool !== "connect") return;

    const element = e.target.closest("[data-id]");
    if(!element) return;

    if(!connectStart){
        connectStart = element.dataset.id;
    }else{
        if(connectStart !== element.dataset.id){
            connections.push({
                from:connectStart,
                to:element.dataset.id
            });
            drawConnections();
        }
        connectStart = null;
    }
});

/* ---------- Double Click Actions ---------- */

window.addEventListener("dblclick",(e)=>{
    if(e.target.closest("[data-id]")) return;

    const worldX=(e.clientX-panX)/zoom;
    const worldY=(e.clientY-panY)/zoom;

    if(e.button === 0){
        createNote(worldX,worldY);
    }
});

window.addEventListener("contextmenu",(e)=>e.preventDefault());

window.addEventListener("mousedown",(e)=>{
    if(e.detail === 2 && e.button === 2){
        if(e.target.closest("[data-id]")) return;

        const worldX=(e.clientX-panX)/zoom;
        const worldY=(e.clientY-panY)/zoom;
        createImage(worldX,worldY);
    }
});

/* ---------- Drag ---------- */

function makeDraggable(el){

    el.addEventListener("mousedown",(e)=>{

        // ðŸ”¥ Allow textarea to be editable
        if(e.target.tagName === "TEXTAREA"){
            return;
        }

        if(currentTool!=="select") return;

        e.stopPropagation();
        e.preventDefault();

        const startX = e.clientX;
        const startY = e.clientY;

        const origLeft = parseFloat(el.style.left);
        const origTop  = parseFloat(el.style.top);

        function onMove(ev){
            const dx = (ev.clientX - startX) / zoom;
            const dy = (ev.clientY - startY) / zoom;

            el.style.left = (origLeft + dx) + "px";
            el.style.top  = (origTop  + dy) + "px";

            drawConnections();
        }

        function onUp(){
            window.removeEventListener("mousemove", onMove);
            window.removeEventListener("mouseup", onUp);
        }

        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", onUp);
    });
}

/* ---------- Draw Connections ---------- */

function drawConnections(){
    connCtx.clearRect(0,0,connCanvas.width,connCanvas.height);

    connections.forEach(conn=>{
        const from=document.querySelector(`[data-id='${conn.from}']`);
        const to=document.querySelector(`[data-id='${conn.to}']`);
        if(!from||!to) return;

        const r1=from.getBoundingClientRect();
        const r2=to.getBoundingClientRect();

        connCtx.beginPath();
        connCtx.moveTo(r1.left+r1.width/2,
                       r1.top+r1.height/2);
        connCtx.lineTo(r2.left+r2.width/2,
                       r2.top+r2.height/2);
        connCtx.strokeStyle="#ff5252";
        connCtx.lineWidth=2;
        connCtx.stroke();
    });
}

updateTransform();
</script>

</body>
</html>
